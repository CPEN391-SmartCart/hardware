/*
 * hx711.c
 *
 *  Created on: Feb 26, 2021
 *      Author: jared
 */

#include "hx711.h"
#include "../io/digital.h"

uint8_t GAIN = 1;

int is_ready()
{
	return digitalRead(DT) == LOW;
}

void set_gain(uint8_t gain)
{
	switch (gain)
	{
		case 128:
			GAIN = 1;
			break;
		case 64:
			GAIN = 3;
			break;
		case 32:
			GAIN = 2;
			break;
	}

	digitalWrite(SCK, LOW);
	read();
}

long read()
{
	while (!is_ready());

	unsigned long value = 0;
	uint8_t data[3] = { 0 };
	uint8_t filler = 0x00;

	data[2] = shiftInMSB(DT, SCK);
	data[1] = shiftInMSB(DT, SCK);
	data[0] = shiftInMSB(DT, SCK);

	for (unsigned int i = 0; i < GAIN; i++)
	{
		digitalWrite(SCK, HIGH);
		digitalWrite(SCK, LOW);
	}

	data[2] = ~data[2];
	data[1] = ~data[1];
	data[0] = ~data[0];

	if (data[2] & 0x80)
	{
		filler = 0xFF;
	}
	else if ((data[2] == 0x7F) && (data[1] == 0xFF) && (data[0] == 0xFF))
	{
		filler = 0xFF;
	}
	else
	{
		filler = 0x00;
	}

	value = (
			(unsigned long)(filler) << 24 |
			(unsigned long)(data[2]) << 16 |
			(unsigned long)(data[1]) << 8 |
			(unsigned long)(data[0])
	);

	return (long)(++value);
}
